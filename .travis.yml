sudo: required
language: python
python:
  - "3.6"
services:
  - docker

install:
  - pip install -r requirements.txt

before_script:

script:
  - pytest
  - npm install -g snyk
#  - snyk test
#  - docker build -t sierra-nginx . --no-cache=True

after_success:
#  - snyk monitor
  - radon cc sierra*.py -as
  - docker login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD
  - export REPO=robster970/sierra-nginx
  - export TAG=`if [ "$TRAVIS_BRANCH" == "master" ]; then echo "latest"; else echo $TRAVIS_BRANCH ; fi`
  - docker build -f Dockerfile -t $REPO:$COMMIT . --no-cache=True
  - docker tag $REPO:$COMMIT $REPO:$TAG
  - docker tag $REPO:$COMMIT $REPO:travis-$TRAVIS_BUILD_NUMBER
  - docker push $REPO
  - docker run -p 127.0.0.1:80:5000 -d -t sierra-nginx
  - docker ps -a
  - curl -v 127.0.0.1:80

